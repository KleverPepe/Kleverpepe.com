<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPEPE Contract Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@klever/web3-sdk@latest/dist/klever-web3.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #0d0d1a; color: #fff; padding: 20px; }
        h1 { color: #4ade80; margin-bottom: 20px; }
        .step { background: #1a1a2e; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .step h3 { color: #a855f7; margin-bottom: 10px; }
        button { width: 100%; padding: 15px; background: #4ade80; border: none; border-radius: 8px; color: #000; font-size: 16px; font-weight: bold; margin: 5px 0; cursor: pointer; }
        button:disabled { background: #666; color: #999; }
        .result { background: #000; padding: 10px; border-radius: 8px; margin-top: 10px; font-family: monospace; font-size: 12px; overflow-x: auto; }
        .status { margin: 20px 0; padding: 15px; background: #1a1a2e; border-radius: 8px; }
        .status.connected { border: 2px solid #4ade80; }
        .status.disconnected { border: 2px solid #f97316; }
    </style>
</head>
<body>
    <h1>ðŸŽ± KPEPE Contract Setup</h1>
    
    <div id="status" class="status disconnected">
        <p>ðŸ”— Wallet: <span id="wallet">Not connected</span></p>
    </div>

    <div class="step">
        <h3>Step 1: Initialize Wallets</h3>
        <p style="color: #999; margin-bottom: 10px; font-size: 14px;">Sets your wallet as project & prize pool wallet</p>
        <button id="btn1" onclick="runStep1()" disabled>Initialize Wallets</button>
        <div id="res1" class="result"></div>
    </div>

    <div class="step">
        <h3>Step 2: Set KPEPE Token</h3>
        <p style="color: #999; margin-bottom: 10px; font-size: 14px;">Links the KPEPE token address</p>
        <button id="btn2" onclick="runStep2()" disabled>Set KPEPE Token</button>
        <div id="res2" class="result"></div>
    </div>

    <div class="step">
        <h3>Step 3: Start Lottery</h3>
        <p style="color: #999; margin-bottom: 10px; font-size: 14px;">Enables ticket purchases</p>
        <button id="btn3" onclick="runStep3()" disabled>Start Lottery</button>
        <div id="res3" class="result"></div>
    </div>

    <script>
        const CONTRACT = 'klv1qqqqqqqqqqqqqpgqeqqq08ulxf7j97vw8mxqq7wwxjgmcwx9ud2scd508d';
        const KPEPE_TOKEN = 'klv1qqqqqqqqqqqqqpgq6xv6kjc603gys4l2jma9szhujxjmnlhnud2s7lwyhl';

        function log(step, msg) {
            document.getElementById('res' + step).innerHTML = msg;
        }

        async function getProvider() {
            if (window.kleverWeb && window.kleverWeb.provider) return window.kleverWeb;
            if (window.klever && window.klever.provider) return window.klever;
            return null;
        }

        async function getAccount() {
            const kp = getProvider();
            if (!kp) throw new Error('Klever wallet not found');
            if (typeof kp.request !== 'function') throw new Error('Provider not ready');
            const accounts = await kp.request({ method: 'account' });
            if (!accounts?.length) throw new Error('No accounts');
            return accounts[0];
        }

        async function sendTx(fn, args = []) {
            const account = await getAccount();
            const tx = {
                chainId: 1,
                type: 'call',
                sender: account,
                contractAddress: CONTRACT,
                functionName: fn,
                args: args,
                gasLimit: 300000
            };
            const kp = getProvider();
            return await kp.request({ method: 'contractCall', params: tx });
        }

        async function checkWallet() {
            try {
                const account = await getAccount();
                document.getElementById('wallet').innerText = account.substring(0, 10) + '...' + account.substring(account.length - 6);
                document.getElementById('status').className = 'status connected';
                document.getElementById('btn1').disabled = false;
                document.getElementById('btn2').disabled = false;
                document.getElementById('btn3').disabled = false;
                return true;
            } catch (e) {
                document.getElementById('wallet').innerText = 'Connect wallet first';
                document.getElementById('status').className = 'status disconnected';
                return false;
            }
        }

        async function runStep1() {
            try {
                const account = await getAccount();
                log(1, 'â³ Sending transaction...');
                const res = await sendTx('initialize_wallets', [account, account]);
                log(1, 'âœ… Success!\nTx: ' + (res?.transactionHash || JSON.stringify(res).substring(0, 200)));
            } catch (e) {
                log(1, 'âŒ Error: ' + e.message);
            }
        }

        async function runStep2() {
            try {
                log(2, 'â³ Sending transaction...');
                const res = await sendTx('set_kpepe_token', [KPEPE_TOKEN]);
                log(2, 'âœ… Success!\nTx: ' + (res?.transactionHash || JSON.stringify(res).substring(0, 200)));
            } catch (e) {
                log(2, 'âŒ Error: ' + e.message);
            }
        }

        async function runStep3() {
            try {
                log(3, 'â³ Sending transaction...');
                const res = await sendTx('toggle_round', []);
                log(3, 'âœ… Success!\nTx: ' + (res?.transactionHash || JSON.stringify(res).substring(0, 200)));
            } catch (e) {
                log(3, 'âŒ Error: ' + e.message);
            }
        }

        // Check wallet on load
        window.addEventListener('load', () => {
            setTimeout(checkWallet, 1000);
        });
    </script>
</body>
</html>
