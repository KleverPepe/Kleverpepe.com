<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üé± KPEPE Jackpot - Win 500K KPEPE!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üê∏</text></svg>">
    <!-- Klever Web3 SDK (fallback) -->
    <script src="https://cdn.jsdelivr.net/npm/@klever/web3-sdk@latest/dist/klever-web3.min.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      :root {
        --primary: #4ade80;
        --purple: #a855f7;
        --orange: #f97316;
        --gold: #fbbf24;
        --bg-dark: #0f0f1a;
        --bg-card: #1a1a2e;
        --text: #ffffff;
        --text-muted: #9ca3af;
        --border: rgba(255,255,255,0.1);
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--bg-dark);
        color: var(--text);
        min-height: 100vh;
      }
      
      /* Interactive Background */
      .bg-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }
      
      .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: rgba(168, 85, 247, 0.3);
        border-radius: 50%;
        animation: float 15s infinite ease-in-out;
      }
      
      .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
      .particle:nth-child(2) { left: 20%; animation-delay: 2s; background: rgba(74, 222, 128, 0.3); }
      .particle:nth-child(3) { left: 30%; animation-delay: 4s; }
      .particle:nth-child(4) { left: 40%; animation-delay: 1s; background: rgba(249, 115, 22, 0.3); }
      .particle:nth-child(5) { left: 50%; animation-delay: 3s; }
      .particle:nth-child(6) { left: 60%; animation-delay: 5s; background: rgba(251, 191, 36, 0.3); }
      .particle:nth-child(7) { left: 70%; animation-delay: 2.5s; }
      .particle:nth-child(8) { left: 80%; animation-delay: 0.5s; background: rgba(168, 85, 247, 0.3); }
      .particle:nth-child(9) { left: 90%; animation-delay: 3.5s; }
      
      @keyframes float {
        0%, 100% { transform: translateY(100vh) scale(0); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100px) scale(1); opacity: 0; }
      }
      
      .glow-orb {
        position: fixed;
        width: 400px;
        height: 400px;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.15;
        pointer-events: none;
        z-index: 0;
      }
      
      .glow-orb.purple { top: -200px; left: -200px; background: var(--purple); animation: pulse-purple 8s ease-in-out infinite; }
      .glow-orb.green { bottom: -200px; right: -200px; background: var(--primary); animation: pulse-green 8s ease-in-out infinite 4s; }
      .glow-orb.orange { top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--orange); animation: pulse-orange 8s ease-in-out infinite 2s; }
      
      @keyframes pulse-purple { 0%, 100% { opacity: 0.15; transform: scale(1); } 50% { opacity: 0.25; transform: scale(1.1); } }
      @keyframes pulse-green { 0%, 100% { opacity: 0.15; transform: scale(1); } 50% { opacity: 0.25; transform: scale(1.1); } }
      @keyframes pulse-orange { 0%, 100% { opacity: 0.1; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.2; transform: translate(-50%, -50%) scale(1.2); } }
      
      .container { position: relative; z-index: 1; max-width: 500px; margin: 0 auto; padding: 16px; }
      
      /* Header */
      .header { text-align: center; padding: 20px 0 16px; }
      .header h1 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--gold), var(--orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }
      .network-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background: rgba(251, 191, 36, 0.15); color: var(--gold); margin-top: 10px; }
      
      /* Interactive Header 8-Ball */
      .header-8ball { font-size: 2.5rem; display: inline-block; animation: float-8ball 4s ease-in-out infinite; cursor: pointer; transition: all 0.3s ease; }
      .header-8ball:hover { animation: spin-8ball 0.6s ease-out; transform: scale(1.1); filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.8)); }
      @keyframes float-8ball { 0%, 100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
      @keyframes spin-8ball { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Header tagline */
      .header-tagline { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
      .tagline-text { color: var(--text-muted); font-size: 0.85rem; }
      .tagline-highlight { background: linear-gradient(135deg, var(--purple), var(--orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
      .tagline-balls { display: flex; gap: 4px; }
      .tagline-ball { width: 20px; height: 20px; border-radius: 50%; background: var(--purple); display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 700; color: #fff; }
      .tagline-ball.eightball { background: linear-gradient(145deg, #1a1a1a, #000); border: 1px solid #fff; }
      
      /* Jackpot Card */
      .jackpot-card { background: linear-gradient(145deg, rgba(168, 85, 247, 0.12), rgba(74, 222, 128, 0.08)); border: 2px solid rgba(168, 85, 247, 0.3); border-radius: 20px; padding: 24px; text-align: center; margin-bottom: 16px; position: relative; overflow: hidden; }
      .jackpot-card::before { content: ''; position: absolute; top: -100%; left: -100%; width: 300%; height: 300%; background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 50%); animation: rotate 20s linear infinite; }
      @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      .jackpot-content { position: relative; z-index: 2; }
      
      /* Interactive Frog */
      .frog-logo { font-size: 3rem; cursor: pointer; transition: all 0.3s ease; display: inline-block; animation: bounce-frog 3s ease-in-out infinite; }
      .frog-logo:hover { transform: scale(1.2) rotate(10deg); filter: drop-shadow(0 0 20px rgba(74, 222, 128, 0.8)); }
      @keyframes bounce-frog { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
      
      .jackpot-amount { font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, var(--purple), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 8px 0; }
      .jackpot-usd { color: var(--text-muted); font-size: 0.9rem; }
      .grand-prize { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, var(--purple), var(--orange)); padding: 10px 20px; border-radius: 30px; margin: 16px 0; font-weight: 700; font-size: 0.95rem; animation: glow-prize 2s ease-in-out infinite; }
      @keyframes glow-prize { 0%, 100% { box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); } 50% { box-shadow: 0 0 25px rgba(249, 115, 22, 0.5); } }
      
      /* Grand Prize Highlight */
      .grand-prize { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, var(--purple), var(--orange)); padding: 12px 24px; border-radius: 30px; margin: 12px 0; font-weight: 700; font-size: 1.1rem; animation: glow-prize 2s ease-in-out infinite; }
      .grand-prize .prize-highlight { background: linear-gradient(135deg, #fff, #ffd700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
      @keyframes glow-prize { 0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.5); } 50% { box-shadow: 0 0 35px rgba(249, 115, 22, 0.6); } }
      
      .pool-amount { font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 8px 0; }
      
      /* Countdown */
      .countdown { background: rgba(251, 191, 36, 0.1); border-radius: 12px; padding: 16px; text-align: center; margin-bottom: 16px; }
      .countdown-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
      .countdown-timer { display: flex; justify-content: center; gap: 12px; }
      .countdown-unit { background: rgba(251, 191, 36, 0.2); padding: 10px 16px; border-radius: 10px; min-width: 60px; }
      .countdown-value { font-size: 1.6rem; font-weight: 800; color: var(--gold); }
      .countdown-unit-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
      
      /* Section Card */
      .section-card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); }
      .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-weight: 600; }
      .section-title .badge { background: var(--purple); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
      .section-title .badge.complete { background: var(--primary); color: #000; }
      
      /* Number Grid - ALL VISIBLE */
      .number-grid { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; max-width: 100%; }
      
      .number-btn { 
        width: 36px; 
        height: 36px; 
        border-radius: 50%; 
        border: 2px solid rgba(255,255,255,0.3); 
        background: #2a2a3e; 
        color: #ffffff; 
        font-size: 0.85rem; 
        font-weight: 700; 
        cursor: pointer; 
        transition: all 0.2s; 
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .number-btn:hover { border-color: var(--purple); background: rgba(168, 85, 247, 0.3); transform: scale(1.1); }
      .number-btn.selected { background: linear-gradient(135deg, var(--purple), #7c3aed); border-color: var(--purple); color: #fff; box-shadow: 0 0 15px rgba(168, 85, 247, 0.6); transform: scale(1.1); }
      
      /* Pool 8 Ball */
      .pool-8ball { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(145deg, #1a1a1a, #000); border: 2px solid #fff; display: inline-flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.1rem; color: #fff; position: relative; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
      
      .number-btn.eightball { background: linear-gradient(145deg, #1a1a1a, #000); border: 2px solid #fff; color: #fff; }
      .number-btn.eightball:hover { background: linear-gradient(145deg, #333, #111); box-shadow: 0 0 15px rgba(255,255,255,0.5); transform: scale(1.1); }
      .number-btn.eightball.selected { background: linear-gradient(145deg, #1a1a1a, #000); border: 3px solid #fff; box-shadow: 0 0 20px rgba(255,255,255,0.6); transform: scale(1.1); }
      
      /* Ticket Preview */
      .ticket-preview { background: rgba(74, 222, 128, 0.08); border: 2px dashed rgba(74, 222, 128, 0.25); border-radius: 16px; padding: 16px; text-align: center; margin-bottom: 12px; }
      .ticket-numbers { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
      .ticket-num { width: 34px; height: 34px; border-radius: 50%; background: var(--purple); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }
      .ticket-num.eightball { background: linear-gradient(145deg, #1a1a1a, #000); border: 2px solid #fff; color: #fff; }
      .ticket-empty { color: var(--text-muted); font-size: 0.8rem; }
      
      /* Quick Pick */
      .quick-pick { display: flex; justify-content: center; gap: 10px; margin-bottom: 12px; }
      .quick-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--text); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
      .quick-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.1); }
      
      /* Cost */
      .cost-display { background: var(--bg-card); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
      .cost-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 0.85rem; }
      .cost-row.total { border-top: 1px dashed var(--border); margin-top: 8px; padding-top: 10px; font-weight: 700; font-size: 1rem; }
      .cost-row .pool { color: var(--primary); }
      .cost-row .project { color: var(--purple); }
      
      /* Buy Button */
      .buy-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--primary), #22c55e); color: #000; font-size: 1rem; font-weight: 800; cursor: pointer; transition: all 0.2s; }
      .buy-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(74, 222, 128, 0.3); }
      .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
      
      /* Prize Tables */
      .prize-table { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
      .prize-header { font-weight: 700; font-size: 0.95rem; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
      .prize-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
      .prize-row:last-child { border-bottom: none; }
      .prize-match { display: flex; align-items: center; gap: 6px; }
      .prize-balls { display: flex; gap: 3px; }
      .prize-ball { width: 22px; height: 22px; border-radius: 50%; background: var(--purple); display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; }
      .prize-ball.eightball { background: linear-gradient(145deg, #1a1a1a, #000); border: 1px solid #fff; color: #fff; }
      .prize-amount { font-weight: 700; color: var(--primary); }
      .prize-row.jackpot { background: linear-gradient(90deg, rgba(74, 222, 128, 0.15), transparent); margin: -8px -16px 8px; padding: 12px 16px; border-radius: 10px; border-bottom: none; }
      .prize-row.jackpot .prize-match { color: var(--primary); font-weight: 700; }
      .prize-row.jackpot .prize-amount { color: var(--gold); }
      
      /* KPEPE prize section */
      .kpepe-section { background: linear-gradient(145deg, rgba(168, 85, 247, 0.2), rgba(249, 115, 22, 0.15)); border: 2px solid rgba(168, 85, 247, 0.5); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
      .kpepe-section .prize-header { color: var(--gold); font-weight: 800; font-size: 1.1rem; }
      .kpepe-section .prize-amount { color: var(--gold); font-weight: 900; font-size: 1.1rem; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
      .kpepe-section .prize-row { border-bottom-color: rgba(251, 191, 36, 0.3); }
      .kpepe-section .prize-row.jackpot { background: linear-gradient(90deg, rgba(168, 85, 247, 0.3), transparent); margin: -8px -16px 8px; padding: 12px 16px; border-radius: 10px; border-bottom: none; }
      .kpepe-section .prize-row.jackpot .prize-match { color: var(--gold); font-weight: 800; }
      .kpepe-section .prize-balls .prize-ball.eightball { color: #fff; }
      
      /* Wallet */
      .wallet-section { background: var(--bg-card); border-radius: 16px; padding: 16px; text-align: center; margin-bottom: 12px; }
      .wallet-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 10px; }
      .wallet-status.disconnected { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
      .wallet-status.connected { background: rgba(74, 222, 128, 0.15); color: var(--primary); }
      
      .footer { text-align: center; padding: 16px; color: var(--text-muted); font-size: 0.75rem; }
      
      /* Frog Popup */
      #frog-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, var(--purple), var(--orange));
        padding: 20px 40px;
        border-radius: 16px;
        font-weight: 700;
        font-size: 1.2rem;
        color: #fff;
        z-index: 9999;
        animation: popup-bounce 0.5s ease-out;
        box-shadow: 0 0 50px rgba(168, 85, 247, 0.8);
        text-align: center;
        min-width: 200px;
        display: none;
      }
      
      @keyframes popup-bounce {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      }
    </style>
  </head>
  <body>
    <!-- Interactive Background -->
    <div class="bg-particles">
      <div class="particle"></div><div class="particle"></div><div class="particle"></div>
      <div class="particle"></div><div class="particle"></div><div class="particle"></div>
      <div class="particle"></div><div class="particle"></div><div class="particle"></div>
    </div>
    <div class="glow-orb purple"></div>
    <div class="glow-orb green"></div>
    <div class="glow-orb orange"></div>

    <!-- Network/Extension banner -->
    <div id="network-banner" style="display:none; position:fixed; top:0; left:0; right:0; padding:10px; background:#f97316; color:#0f0f1a; font-weight:700; text-align:center; z-index:50; box-shadow:0 2px 6px rgba(0,0,0,0.35);">
      ‚ö†Ô∏è Klever Wallet Required! Install <a href="https://klever.io/wallet" target="_blank" style="color:#0f0f1a; text-decoration:underline;">Klever Extension</a>, then <button onclick="location.reload()" style="background:#0f0f1a; color:#f97316; border:none; padding:4px 12px; border-radius:4px; cursor:pointer; font-weight:700; margin-left:8px;">Reload Page</button>
    </div>
    
    <!-- Frog Popup -->
    <div id="frog-popup"></div>
    
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-8ball" onclick="showFrogMessage()">üé±</div>
        <h1>KPEPE Jackpot</h1>
        <div class="header-tagline">
          <span class="tagline-text">Pick your numbers to win!</span>
          <div class="tagline-balls">
            <div class="tagline-ball">5</div>
            <div class="tagline-ball eightball">8</div>
          </div>
        </div>
        <div class="network-badge">üîó Mainnet</div>
      </div>
      
      <!-- Jackpot -->
      <div class="jackpot-card">
        <div class="jackpot-content">
          <div class="frog-logo" onclick="showFrogMessage()">üê∏</div>
          <div class="grand-prize">üåü <span class="prize-highlight">500,000 KPEPE</span> Grand Prize!</div>
          <div class="pool-amount"><span id="jackpot-klv">0</span> KLV</div>
          <div class="jackpot-usd" id="jackpot-usd">Total: ~$0 USD</div>
          <div style="margin-top: 12px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
            <button onclick="showCalculatedPool()" style="padding: 6px 16px; border-radius: 8px; border: 1px solid rgba(74,222,128,0.3); background: rgba(74,222,128,0.1); color: #4ade80; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(74,222,128,0.2)'" onmouseout="this.style.background='rgba(74,222,128,0.1)'">
              üîÑ Refresh Pool
            </button>
            <div style="font-size: 0.75rem; color: #fbbf24;">üìä Based on confirmed tickets</div>
          </div>
        </div>
      </div>
      
      <!-- Countdown -->
      <div class="countdown">
        <div class="countdown-label">Next draw in</div>
        <div class="countdown-timer">
          <div class="countdown-unit"><div class="countdown-value" id="timer-h">00</div><div class="countdown-unit-label">Hrs</div></div>
          <div class="countdown-unit"><div class="countdown-value" id="timer-m">00</div><div class="countdown-unit-label">Min</div></div>
          <div class="countdown-unit"><div class="countdown-value" id="timer-s">00</div><div class="countdown-unit-label">Sec</div></div>
        </div>
      </div>
      
      <!-- Ticket Preview -->
      <div class="ticket-preview">
        <div style="font-size: 0.8rem; color: var(--text-muted);">Your Numbers</div>
        <div class="ticket-numbers" id="ticket-numbers"><span class="ticket-empty">Pick numbers or Quick Pick</span></div>
      </div>
      
      <!-- Quick Pick -->
      <div class="quick-pick">
        <button class="quick-btn" onclick="quickPick()">üé≤ Quick Pick</button>
        <button class="quick-btn" onclick="clearSelection()">üóëÔ∏è Clear</button>
      </div>
      
      <!-- Main Numbers - ALL 50 VISIBLE -->
      <div class="section-card">
        <div class="section-title"><span>Main Numbers (1-50)</span><span class="badge" id="main-count">0/5</span></div>
        <div class="number-grid" id="main-numbers"></div>
      </div>
      
      <!-- Lucky 8Ball - ALL 20 VISIBLE -->
      <div class="section-card">
        <div class="section-title">
          <div style="display: flex; align-items: center; gap: 8px;"><div class="pool-8ball">8</div><span>Lucky 8Ball (1-20)</span></div>
          <span class="badge" id="8b-count">0/1</span>
        </div>
        <div class="number-grid" id="eightball-numbers"></div>
      </div>
      
      <!-- Cost & Buy -->
      <div class="cost-display">
        <div style="font-weight: 700; margin-bottom: 8px; color: var(--primary);">üí∞ Revenue Split Per Ticket</div>
        <div class="cost-row">
          <span>üèÜ To Prize Pool</span>
          <span class="pool">85 KLV (85%)</span>
        </div>
        <div class="cost-row">
          <span>üíº To Project Wallet</span>
          <span class="project">15 KLV (15%)</span>
        </div>
        <div class="cost-row total">
          <span>Total Ticket Price</span>
          <span>100 KLV</span>
        </div>
        <div style="margin-top: 8px; padding: 8px; background: rgba(74,222,128,0.1); border-radius: 8px; font-size: 0.75rem; color: var(--text-muted);">
          ‚úÖ Split happens automatically on every purchase
        </div>
      </div>
      
      <button class="buy-btn" id="buy-btn" onclick="buyTickets()">üé´ Buy Ticket (100 KLV)</button>
      
      <!-- KPEPE Prize Pool -->
      <div class="prize-table kpepe-section">
        <div class="prize-header">üåü 500K KPEPE Grand Prize</div>
        <div class="prize-row jackpot">
          <div class="prize-match"><div class="prize-balls"><div class="prize-ball">5</div><div class="prize-ball eightball">8</div></div><span>üéâ JACKPOT</span></div>
          <span class="prize-amount">500,000 KPEPE</span>
        </div>
      </div>
      
      <!-- KLV Prize Pool -->
      <div class="prize-table">
        <div class="prize-header">üèÜ KLV Prize Pool</div>
        <div class="prize-row jackpot">
          <div class="prize-match"><div class="prize-balls"><div class="prize-ball">5</div><div class="prize-ball eightball">8</div></div><span>üé∞ JACKPOT</span></div>
          <span class="prize-amount" id="prize-jackpot">~0 KLV</span>
        </div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">5</div></div><span>Match 5</span></div><span class="prize-amount" id="prize-match5">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">4</div><div class="prize-ball eightball">8</div></div><span>Match 4+8B</span></div><span class="prize-amount" id="prize-match4_8b">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">4</div></div><span>Match 4</span></div><span class="prize-amount" id="prize-match4">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">3</div><div class="prize-ball eightball">8</div></div><span>Match 3+8B</span></div><span class="prize-amount" id="prize-match3_8b">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">3</div></div><span>Match 3</span></div><span class="prize-amount" id="prize-match3">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">2</div><div class="prize-ball eightball">8</div></div><span>Match 2+8B</span></div><span class="prize-amount" id="prize-match2_8b">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball">1</div><div class="prize-ball eightball">8</div></div><span>Match 1+8B</span></div><span class="prize-amount" id="prize-match1_8b">~0 KLV</span></div>
        <div class="prize-row"><div class="prize-match"><div class="prize-balls"><div class="prize-ball eightball">8</div></div><span>Lucky 8Ball only</span></div><span class="prize-amount" id="prize-luckyball">~0 KLV</span></div>
      </div>
      
      <!-- Wallet -->
      <div class="wallet-section">
        <div id="wallet-warning" style="display:none; color:#f97316; font-size:0.85rem; margin-bottom:6px;">
          ‚ö†Ô∏è No wallet detected. Install <a href="https://klever.io/wallet" target="_blank" style="color:#f97316; text-decoration:underline;">Klever Extension</a> or <a href="https://metamask.io" target="_blank" style="color:#f97316; text-decoration:underline;">MetaMask</a>
        </div>
        <div class="wallet-status disconnected" id="wallet-status"><span>‚óè</span> Not Connected</div>
        <button class="buy-btn" style="padding: 10px 20px; font-size: 0.9rem;" onclick="connectWallet()">üîó Connect Wallet</button>
      </div>

      <!-- Claim Prize Section -->
      <div class="section-card">
        <div class="section-title">
          <span>üéÅ Claim Your Prize</span>
          <div class="badge">After Draw</div>
        </div>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">
          After the draw is completed and winning numbers are announced, enter your ticket ID to claim your prize!
        </p>
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <input 
            type="number" 
            id="claim-ticket-id" 
            placeholder="Enter Ticket ID (0-9999)" 
            min="0" 
            style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-dark); color: var(--text); font-size: 1rem;"
          />
        </div>
        <button class="buy-btn" onclick="claimPrize()" style="background: linear-gradient(135deg, #f97316, #ea580c);">
          üéÅ Claim Prize
        </button>
        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 12px; text-align: center;">
          Your ticket ID is shown when you purchase a ticket.<br/>
          Winners are determined by number matches and Eight Ball.
        </p>
      </div>
      
      <div class="footer">üé± KPEPE Jackpot on KleverChain<br><span style="opacity: 0.6;">Mainnet</span></div>
    </div>

    <script>
      const TICKET_PRICE = 1, POOL_SHARE = 0.85, MAIN_NUMBERS = 50, EIGHTBALL_NUMBERS = 20, MAIN_PICK = 5;
      let selectedMainNumbers = [], selectedEightball = null;
      const KPEPE_JACKPOT = 500000;
      // Contract address (deployed on KleverChain mainnet)
      const CONTRACT_ADDRESS = "klv1qqqqqqqqqqqqqpgqeqqq08ulxf7j97vw8mxqq7wwxjgmcwx9ud2scd508d";
      // KPEPE Token address on KleverChain mainnet
      const KPEPE_TOKEN_ADDRESS = "kpepe-1eod"; // KleverChain token identifier
      // KleverScan API endpoints (ordered fallback; will be updated at runtime if provider.api exists)
      const DEFAULT_KLEVERSCAN_API = "https://api.mainnet.klever.org";
      
      // Network configuration for KleverChain
      const KLEVER_NETWORK = {
        chainId: '0x8F4', // 2292 in decimal for KleverChain mainnet
        chainName: 'KleverChain Mainnet',
        nativeCurrency: {
          name: 'Klever',
          symbol: 'KLV',
          decimals: 6
        },
        rpcUrls: ['https://node.klever.finance'],
        blockExplorerUrls: ['https://kleverscan.org']
      };
      let KLEVERSCAN_ENDPOINTS = [DEFAULT_KLEVERSCAN_API];
      // Demo: tickets sold (update from contract in production)
      let TOTAL_TICKETS_SOLD = 0;
      // Prize percentages of pool
      const PRIZE_PERCENTAGES = {
        jackpot: 0.40,
        match5: 0.15,
        match4_8b: 0.08,
        match4: 0.05,
        match3_8b: 0.06,
        match3: 0.045,
        match2_8b: 0.03,
        match1_8b: 0.015,
        luckyball: 0.0125
      };
      // Fixed prices (update these manually if API fails)
      const KPEPE_PRICE_USD = 0.005371;
      const KLV_PRICE_USD = 0.00152832;
      let prizePoolFetchWarned = false;
      
      // Enable live prize pool display from test tickets
      let prizeFetchDisabled = false;
      let calculatedPoolShown = false;

      document.addEventListener('DOMContentLoaded', () => {
        initNumberPickers();
        // Show calculated pool from confirmed test tickets
        showCalculatedPool();
        // Try to refresh every 30 seconds
        setInterval(() => { showCalculatedPool(); }, 30000);
        startCountdown();
      });
      
      function showFrogMessage() {
        const msgs = ['üê∏ Good luck!', 'üçÄ Frog blesses you!', 'üé∞ Fortune awaits!', 'üåü Jackpot energy!'];
        const popup = document.getElementById('frog-popup');
        popup.textContent = msgs[Math.floor(Math.random() * msgs.length)];
        popup.style.display = 'block';
        setTimeout(() => { popup.style.display = 'none'; }, 2000);
      }
      
      function initNumberPickers() {
        const mainGrid = document.getElementById('main-numbers'), ebGrid = document.getElementById('eightball-numbers');
        for (let i = 1; i <= MAIN_NUMBERS; i++) { const btn = document.createElement('button'); btn.className = 'number-btn'; btn.textContent = i; btn.onclick = () => toggleMainNumber(i, btn); mainGrid.appendChild(btn); }
        for (let i = 1; i <= EIGHTBALL_NUMBERS; i++) { const btn = document.createElement('button'); btn.className = 'number-btn eightball'; btn.textContent = i; btn.onclick = () => toggleEightball(i, btn); ebGrid.appendChild(btn); }
      }
      
      function toggleMainNumber(num, btn) {
        const idx = selectedMainNumbers.indexOf(num);
        if (idx > -1) { selectedMainNumbers.splice(idx, 1); btn.classList.remove('selected'); }
        else if (selectedMainNumbers.length < MAIN_PICK) { selectedMainNumbers.push(num); selectedMainNumbers.sort((a,b) => a-b); btn.classList.add('selected'); }
        updateUI();
      }
      
      function toggleEightball(num, btn) {
        if (selectedEightball === num) { selectedEightball = null; btn.classList.remove('selected'); }
        else { selectedEightball = num; document.querySelectorAll('.number-btn.eightball').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        updateUI();
      }
      
      function quickPick() {
        selectedMainNumbers = []; selectedEightball = null; document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('selected'));
        while (selectedMainNumbers.length < MAIN_PICK) { const n = Math.floor(Math.random() * MAIN_NUMBERS) + 1; if (!selectedMainNumbers.includes(n)) selectedMainNumbers.push(n); }
        selectedMainNumbers.sort((a,b) => a-b); selectedEightball = Math.floor(Math.random() * EIGHTBALL_NUMBERS) + 1;
        document.querySelectorAll('.number-btn').forEach(btn => {
          const n = parseInt(btn.textContent);
          if (selectedMainNumbers.includes(n)) btn.classList.add('selected');
          if (btn.classList.contains('eightball') && parseInt(btn.textContent) === selectedEightball) btn.classList.add('selected');
        });
        updateUI();
      }
      
      function clearSelection() {
        selectedMainNumbers = [];
        selectedEightball = null;
        document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('selected'));
        updateUI();
      }
      
      function updateUI() {
        document.getElementById('main-count').textContent = selectedMainNumbers.length + '/' + MAIN_PICK;
        document.getElementById('8b-count').textContent = (selectedEightball ? 1 : 0) + '/1';
        document.getElementById('main-count').classList.toggle('complete', selectedMainNumbers.length === MAIN_PICK);
        document.getElementById('8b-count').classList.toggle('complete', !!selectedEightball);
        
        const ticketNumbers = document.getElementById('ticket-numbers');
        if (selectedMainNumbers.length === 0 && !selectedEightball) {
          ticketNumbers.innerHTML = '<span class="ticket-empty">Pick numbers or Quick Pick</span>';
        } else {
          let html = '';
          selectedMainNumbers.forEach(num => { html += '<div class="ticket-num">' + num + '</div>'; });
          if (selectedEightball) { html += '<div class="ticket-num eightball">' + selectedEightball + '</div>'; }
          ticketNumbers.innerHTML = html;
        }
        
        const canBuy = selectedMainNumbers.length === MAIN_PICK && selectedEightball;
        const buyBtn = document.getElementById('buy-btn');
        buyBtn.disabled = !canBuy;
        buyBtn.style.opacity = canBuy ? '1' : '0.5';
      }
      
      function loadStats() {
        // In production, fetch from contract:
        // fetchPrizePoolFromContract().then(pool => { ... })
        
        const poolAmount = Math.floor(TOTAL_TICKETS_SOLD * TICKET_PRICE * POOL_SHARE);
        const kpepeValueUSD = KPEPE_JACKPOT * KPEPE_PRICE_USD;
        const klvValueUSD = poolAmount * KLV_PRICE_USD;
        const totalUSD = kpepeValueUSD + klvValueUSD;
        document.getElementById('jackpot-klv').textContent = poolAmount.toLocaleString();
        document.getElementById('jackpot-usd').textContent = 'Total: ~$' + totalUSD.toFixed(2) + ' USD';
        updatePrizeAmounts(poolAmount);
      }
      
      // Live fetch from KleverChain (for production)
      async function fetchPrizePoolFromContract() {
        for (const base of KLEVERSCAN_ENDPOINTS) {
          try {
            const url = `${base}/v1/contract/${CONTRACT_ADDRESS}/state`;
            const response = await fetch(url, { mode: 'cors' });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const prizePoolRaw = Number(data?.prizePool ?? 0);
            const ticketsSold = Number(data?.totalTicketsSold ?? 0);
            const poolAmount = Math.floor(prizePoolRaw / 1e6);
            TOTAL_TICKETS_SOLD = ticketsSold;
            document.getElementById('jackpot-klv').textContent = poolAmount.toLocaleString();
            const totalUSD = (KPEPE_JACKPOT * KPEPE_PRICE_USD) + (poolAmount * KLV_PRICE_USD);
            document.getElementById('jackpot-usd').textContent = 'Total: ~$' + totalUSD.toFixed(2) + ' USD';
            updatePrizeAmounts(poolAmount);
            return;
          } catch (err) {
            console.warn(`KleverScan fetch failed for ${base}`, err);
          }
        }
        // Fallback to calculated pool
        showCalculatedPool();
      }
      
      function showCalculatedPool() {
        // Based on confirmed transactions:
        // 2 tickets purchased at 100 KLV each
        // 85% goes to pool = 85 KLV per ticket
        const confirmedTickets = 2;
        const poolPerTicket = 85; // 85 KLV per ticket to pool (85% of 100 KLV)
        const poolAmount = confirmedTickets * poolPerTicket; // 170 KLV
        
        document.getElementById('jackpot-klv').textContent = poolAmount.toFixed(2) + ' KLV';
        const totalUSD = (KPEPE_JACKPOT * KPEPE_PRICE_USD) + (poolAmount * KLV_PRICE_USD);
        document.getElementById('jackpot-usd').textContent = 'Total: ~$' + totalUSD.toFixed(2) + ' USD';
        updatePrizeAmounts(poolAmount);
        
        if (!calculatedPoolShown) {
          console.log(`üìä Prize pool calculated from ${confirmedTickets} confirmed tickets: ${poolAmount} KLV`);
          calculatedPoolShown = true;
        }
      }
      
      function updatePrizeAmounts(poolAmount) {
        const formatPrize = (amount) => {
          if (amount >= 1000) return '~' + (amount / 1000).toFixed(1) + 'K KLV';
          return '~' + amount.toLocaleString() + ' KLV';
        };
        
        const prizes = {
          'prize-jackpot': poolAmount,
          'prize-match5': Math.floor(poolAmount * PRIZE_PERCENTAGES.match5),
          'prize-match4_8b': Math.floor(poolAmount * PRIZE_PERCENTAGES.match4_8b),
          'prize-match4': Math.floor(poolAmount * PRIZE_PERCENTAGES.match4),
          'prize-match3_8b': Math.floor(poolAmount * PRIZE_PERCENTAGES.match3_8b),
          'prize-match3': Math.floor(poolAmount * PRIZE_PERCENTAGES.match3),
          'prize-match2_8b': Math.floor(poolAmount * PRIZE_PERCENTAGES.match2_8b),
          'prize-match1_8b': Math.floor(poolAmount * PRIZE_PERCENTAGES.match1_8b),
          'prize-luckyball': Math.floor(poolAmount * PRIZE_PERCENTAGES.luckyball)
        };
        
        Object.keys(prizes).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = formatPrize(prizes[id]);
        });
      }
      
      function startCountdown() {
        const target = new Date().getTime() + (24 * 60 * 60 * 1000);
        function update() {
          const now = new Date().getTime(), diff = target - now;
          if (diff <= 0) return;
          const h = Math.floor(diff / (1000 * 60 * 60)), m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)), s = Math.floor((diff % (1000 * 60)) / 1000);
          document.getElementById('timer-h').textContent = String(h).padStart(2, '0');
          document.getElementById('timer-m').textContent = String(m).padStart(2, '0');
          document.getElementById('timer-s').textContent = String(s).padStart(2, '0');
        }
        update(); setInterval(update, 1000);
      }
      
      // Klever Web3 Integration
      let kleverWeb3 = null;
      let connectedWallet = null;
      let extensionDetected = false;
      let providerPollTimer = null;

      function resolveKleverProvider() {
        console.log('üîç resolveKleverProvider() called');
        if (window.klever) {
          console.log('  ‚úÖ Using window.klever');
          return window.klever;
        }
        
        if (window.kleverWeb && window.kleverWeb.provider) {
          console.log('  ‚úÖ Using window.kleverWeb.provider');
          return window.kleverWeb.provider;
        }
        
        if (window.kleverWeb) {
          console.log('  ‚ö†Ô∏è Using window.kleverWeb (no nested provider)');
          return window.kleverWeb;
        }
        
        if (window.kleverWeb3) {
          console.log('  ‚úÖ Using window.kleverWeb3');
          return window.kleverWeb3;
        }
        
        console.log('  ‚ùå No provider found');
        return null;
      }

      function setNetworkBadge(text) {
        const badge = document.querySelector('.network-badge');
        if (badge) badge.textContent = text;
      }

      function setWalletStatus(text, isConnected) {
        const statusEl = document.getElementById('wallet-status');
        const connectBtn = document.querySelector('button[onclick="connectWallet()"]');
        const warnEl = document.getElementById('wallet-warning');
        const banner = document.getElementById('network-banner');
        if (isConnected) {
          statusEl.classList.remove('disconnected');
          statusEl.classList.add('connected');
        } else {
          statusEl.classList.remove('connected');
          statusEl.classList.add('disconnected');
        }
        statusEl.innerHTML = text;
        connectBtn.textContent = isConnected ? 'üîó Disconnect Wallet' : 'üîó Connect Wallet';
        connectBtn.onclick = isConnected ? disconnectWallet : connectWallet;
        if (warnEl) warnEl.style.display = isConnected ? 'none' : warnEl.style.display;
        if (banner) banner.style.display = isConnected ? 'none' : banner.style.display;
      }

      async function initializeKleverWeb3() {
        const providerApi = (window.kleverWeb && window.kleverWeb.provider && window.kleverWeb.provider.api) ||
                             (window.klever && window.klever.provider && window.klever.provider.api) ||
                             DEFAULT_KLEVERSCAN_API;
        KLEVERSCAN_ENDPOINTS = [providerApi];
        
        // Check for Klever provider first, then other Web3 providers
        kleverWeb3 = resolveKleverProvider();
        const hasEthereum = typeof window.ethereum !== 'undefined';
        
        if (kleverWeb3 || hasEthereum) {
          extensionDetected = true;
          if (kleverWeb3) {
            console.log('‚úÖ Klever Web3 provider detected');
            console.log('Provider keys:', Object.keys(kleverWeb3 || {}));
          }
          if (hasEthereum && !kleverWeb3) {
            console.log('‚úÖ Ethereum provider detected (MetaMask)');
          }
          setNetworkBadge('üîó Mainnet');
          setWalletStatus('<span>‚óè</span> Not Connected', false);
          // Hide banner when provider is available
          const banner = document.getElementById('network-banner');
          if (banner) banner.style.display = 'none';
          const warnEl = document.getElementById('wallet-warning');
          if (warnEl) warnEl.style.display = 'none';
        } else {
          extensionDetected = false;
          console.warn('‚ö†Ô∏è No Web3 wallet detected');
          setNetworkBadge('üîó Mainnet');
          const warnEl = document.getElementById('wallet-warning');
          if (warnEl) warnEl.style.display = 'block';
          const banner = document.getElementById('network-banner');
          if (banner) banner.style.display = 'block';
          setWalletStatus('<span>‚óè</span> Connect Wallet', false);
        }
      }

      function startProviderPolling() {
        if (providerPollTimer) return;
        let attempts = 0;
        const maxAttempts = 30; // Poll for up to 60 seconds
        
        providerPollTimer = setInterval(() => {
          const hasKlever = !!(window.klever || window.kleverWeb || window.kleverWeb3);
          const hasEthereum = typeof window.ethereum !== 'undefined';
          
          if (kleverWeb3 || hasKlever || hasEthereum) { 
            clearInterval(providerPollTimer); 
            providerPollTimer = null;
            
            if (hasKlever || hasEthereum) {
              extensionDetected = true;
              kleverWeb3 = resolveKleverProvider();
              
              console.log('‚úÖ Web3 provider detected via polling on attempt', attempts + 1);
              console.log('Detected providers:', {
                klever: !!window.klever,
                kleverWeb: !!window.kleverWeb,
                ethereum: !!window.ethereum
              });
              
              const providerApi = (window.kleverWeb && window.kleverWeb.provider && window.kleverWeb.provider.api) || DEFAULT_KLEVERSCAN_API;
              KLEVERSCAN_ENDPOINTS = [providerApi];
              setNetworkBadge('üîó Mainnet');
              setWalletStatus('<span>‚óè</span> Not Connected', false);
              
              const banner = document.getElementById('network-banner');
              if (banner) banner.style.display = 'none';
              const warnEl = document.getElementById('wallet-warning');
              if (warnEl) warnEl.style.display = 'none';
            }
            return; 
          }
          
          kleverWeb3 = resolveKleverProvider();
          attempts += 1;
          
          if (attempts % 5 === 0) {
            console.log(`‚è≥ Polling for wallet providers... (attempt ${attempts}/${maxAttempts})`);
          }
          
          if (attempts >= maxAttempts) {
            clearInterval(providerPollTimer); 
            providerPollTimer = null;
            console.warn('‚ö†Ô∏è No Web3 wallet detected after polling');
            console.warn('Please install Klever Extension from: https://klever.io/wallet');
            console.warn('Or install MetaMask from: https://metamask.io');
            
            const banner = document.getElementById('network-banner');
            if (banner) banner.style.display = 'block';
          }
        }, 2000);
      }

      async function requestAccounts() {
        if (!kleverWeb3) return [];
        
        console.log('üîÑ requestAccounts() called');
        
        // First, ensure window.kleverWeb is initialized
        if (window.kleverWeb) {
          console.log('üîÑ Using window.kleverWeb object');
          console.log('   Properties:', {
            name: window.kleverWeb.name,
            address: window.kleverWeb.address,
            isKlever: window.kleverWeb.isKlever,
            version: window.kleverWeb.version
          });
          
          // Step 1: Initialize if not already done
          let initialized = false;
          if (typeof window.kleverWeb.init === 'function') {
            console.log('üîÑ Initializing window.kleverWeb...');
            try {
              const initResult = await window.kleverWeb.init();
              console.log('‚úÖ init() returned:', initResult);
              initialized = true;
            } catch (e) {
              console.warn('init() failed:', e.message);
            }
          }
          
          // Try alternative initialize() method
          if (!initialized && typeof window.kleverWeb.initialize === 'function') {
            console.log('üîÑ Trying initialize() instead...');
            try {
              const initResult = await window.kleverWeb.initialize();
              console.log('‚úÖ initialize() returned:', initResult);
              initialized = true;
            } catch (e) {
              console.warn('initialize() failed:', e.message);
            }
          }
          
          // Step 2: Now try to get wallet address
          console.log('üîÑ Attempting to get wallet address...');
          if (typeof window.kleverWeb.getWalletAddress === 'function') {
            try {
              const addr = await window.kleverWeb.getWalletAddress();
              console.log('‚úÖ getWalletAddress returned:', addr);
              if (addr) return [addr];
            } catch (e) {
              console.warn('getWalletAddress failed:', e.message);
            }
          }
          
          // Step 3: Check if address property is now available
          if (window.kleverWeb.address) {
            console.log('‚úÖ wallet address available on property:', window.kleverWeb.address);
            return [window.kleverWeb.address];
          }
          
          // Step 4: Try calling sendMessage via communication
          if (window.kleverWeb.communication && typeof window.kleverWeb.communication.sendMessage === 'function') {
            console.log('üîÑ Trying communication.sendMessage()...');
            try {
              const msg = {
                method: 'getAddress',
                params: {}
              };
              console.log('  Sending message:', msg);
              const response = await window.kleverWeb.communication.sendMessage(msg);
              console.log('  ‚úÖ Response:', response);
              if (response && response.address) {
                return [response.address];
              }
            } catch (e) {
              console.warn('    communication.sendMessage failed:', e.message);
            }
          }
        }
        
        console.log('‚ùå requestAccounts - no accounts found via any method');
        return [];
      }

      async function switchToKleverNetwork() {
        if (typeof window.ethereum === 'undefined') {
          throw new Error('No Ethereum provider found');
        }
        
        try {
          // Try to switch to KleverChain network
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: KLEVER_NETWORK.chainId }],
          });
          console.log('‚úÖ Switched to KleverChain network');
        } catch (switchError) {
          // Network not added, try to add it
          if (switchError.code === 4902 || switchError.code === -32603) {
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [KLEVER_NETWORK],
              });
              console.log('‚úÖ Added and switched to KleverChain network');
            } catch (addError) {
              console.error('Failed to add KleverChain network:', addError);
              throw addError;
            }
          } else {
            throw switchError;
          }
        }
      }

      async function connectWallet() {
        console.log('üîç Attempting wallet connection...');
        
        try {
          // Get the resolved provider
          kleverWeb3 = resolveKleverProvider();
          console.log('üîç Resolved provider:', {
            hasProvider: !!kleverWeb3,
            providerType: kleverWeb3 ? kleverWeb3.constructor?.name : 'unknown',
            methods: kleverWeb3 ? Object.keys(kleverWeb3).slice(0, 10) : []
          });

          if (!kleverWeb3) {
            alert('‚ùå Klever Wallet not detected.\n\nPlease install Klever Extension from:\nhttps://klever.io/wallet');
            return;
          }

          // Use requestAccounts from the provider
          console.log('üîÑ Requesting accounts from Klever provider...');
          const accounts = await requestAccounts();
          
          if (accounts && accounts.length > 0) {
            connectedWallet = accounts[0];
            updateWalletUI(true, connectedWallet);
            console.log('‚úÖ Wallet successfully connected:', connectedWallet);
            return;
          }

          // If no accounts returned, try direct wallet address methods if available
          if (window.klever && typeof window.klever.getWalletAddress === 'function') {
            console.log('üîÑ Trying direct getWalletAddress() from window.klever...');
            try {
              const addr = await window.klever.getWalletAddress();
              if (addr) {
                connectedWallet = addr;
                updateWalletUI(true, connectedWallet);
                console.log('‚úÖ Wallet connected via getWalletAddress:', connectedWallet);
                return;
              }
            } catch (e) {
              console.warn('getWalletAddress failed:', e.message);
            }
          }

          console.error('‚ùå No accounts returned from any method');
          alert('‚ö†Ô∏è Klever Wallet detected but could not retrieve accounts.\n\nPlease:\n1. Unlock your Klever wallet\n2. Approve this site in your extension settings\n3. Ensure you are on KleverChain Mainnet\n4. Try again');

        } catch (error) {
          console.error('‚ùå Wallet connection error:', error);
          console.error('Error details:', {
            message: error.message,
            code: error.code,
            stack: error.stack
          });
          alert('‚ùå Failed to connect Klever Wallet.\n\nError: ' + error.message + '\n\nCheck browser console (F12) for details.');
        }
      }

      function disconnectWallet() {
        connectedWallet = null;
        updateWalletUI(false, null);
        console.log('Wallet disconnected');
      }

      function updateWalletUI(connected, address) {
        if (connected && address) {
          const shortAddr = address.substring(0, 8) + '...' + address.substring(address.length - 6);
          setWalletStatus(`<span>‚óè</span> Connected: ${shortAddr}`, true);
        } else {
          setWalletStatus('<span>‚óè</span> Not Connected', false);
        }
      }

      function setupWalletListeners() {
        if (!kleverWeb3) return;
        if (typeof kleverWeb3.on !== 'function') {
          console.log('‚ö†Ô∏è Provider does not support .on() events');
          return;
        }
        kleverWeb3.on('accountsChanged', (accounts) => {
          if (accounts && accounts.length > 0) {
            connectedWallet = accounts[0];
            updateWalletUI(true, connectedWallet);
          } else {
            disconnectWallet();
          }
        });
      }

      window.addEventListener('load', () => {
        setNetworkBadge('üîó Mainnet');
        initializeKleverWeb3();
        startProviderPolling();
        
        // Initialize kleverWeb if available
        if (window.kleverWeb && typeof window.kleverWeb.init === 'function') {
          console.log('üîÑ Initializing kleverWeb at page load...');
          window.kleverWeb.init().then(() => {
            console.log('‚úÖ kleverWeb initialized successfully');
          }).catch(e => {
            console.warn('‚ö†Ô∏è kleverWeb init failed:', e.message);
          });
        }
        
        window.addEventListener('klever#initialized', () => {
          console.log('klever#initialized event received');
          kleverWeb3 = resolveKleverProvider();
          if (kleverWeb3) {
            extensionDetected = true;
            setWalletStatus('<span>‚óè</span> Not Connected', false);
          }
        });
        setupWalletListeners();
        // If after 3s no provider, keep banner visible to prompt user
        setTimeout(() => {
          if (!resolveKleverProvider()) {
            const banner = document.getElementById('network-banner');
            if (banner) banner.style.display = 'block';
          }
        }, 3000);
      });
      
      async function buyTickets() {
        if (!connectedWallet) {
          alert('‚ùå Please connect your Klever wallet first!');
          return;
        }
        if (selectedMainNumbers.length !== MAIN_PICK || !selectedEightball) {
          alert('Please select 5 main numbers and 1 Lucky 8Ball!');
          return;
        }
        const [n1, n2, n3, n4, n5] = selectedMainNumbers;
        const eb = selectedEightball;
        
        console.log('üé´ Attempting to buy ticket...');
        console.log('Connected wallet:', connectedWallet);
        console.log('Numbers:', [n1, n2, n3, n4, n5], 'Eight Ball:', eb);
        
        try {
          // Use window.kleverWeb for transactions
          if (!window.kleverWeb) {
            alert('‚ùå Klever Wallet not available.\n\nPlease ensure Klever Extension is installed and connected.');
            return;
          }
          
          console.log('üîÑ Preparing transaction via Klever...');
          
          // WASM contract call - use buy_ticket endpoint
          // Based on Rust contract: #[endpoint] #[payable("KLV")] fn buy_ticket(num1, num2, num3, num4, num5, eb)
          const functionName = 'buy_ticket'; // Rust endpoint name (snake_case)
          const functionArgs = [n1, n2, n3, n4, n5, eb]; // Numbers as raw integers
          
          // For WASM contracts on KleverChain, use Transfer (type 0) with data field
          // The contract address is the receiver, and data contains the function call
          const payload = {
            receiver: CONTRACT_ADDRESS,
            amount: TICKET_PRICE * 100000000, // 1 KLV in smallest units (payable)
            kda: '', // Empty = KLV
            data: [functionName, ...functionArgs.map(String)] // Function name + args as strings
          };
          
          const txParams = {
            type: 0, // Transfer type (used for contract calls with payment)
            payload
          };
          
          console.log('üì§ Building transaction with params:', txParams);
          
          try {
            // Step 1: Build transaction - pass as array
            console.log('üîÑ Step 1: Building transaction...');
            const builtTx = await window.kleverWeb.buildTransaction([txParams]);
            console.log('‚úÖ Transaction built:', builtTx);
            
            // Step 2: Sign transaction
            console.log('üîÑ Step 2: Signing transaction...');
            const signedTx = await window.kleverWeb.signTransaction(builtTx);
            console.log('‚úÖ Transaction signed:', signedTx);
            
            // Step 3: Broadcast transaction
            console.log('üîÑ Step 3: Broadcasting transaction...');
            const result = await window.kleverWeb.broadcastTransactions([signedTx]);
            console.log('‚úÖ Transaction broadcast result:', result);
            
            if (result && result.data && result.data.txsHashes && result.data.txsHashes.length > 0) {
              const txHash = result.data.txsHashes[0];
              console.log('‚úÖ Transaction hash:', txHash);
              alert('üé´ Ticket purchased on KleverChain!\n\nTransaction: ' + txHash + '\n\nYour Numbers:\nMain: ' + selectedMainNumbers.join(', ') + '\nLucky 8Ball: ' + selectedEightball + '\n\nGood luck! üçÄ');
              clearSelection();
            } else {
              console.warn('Transaction result:', result);
              alert('‚úÖ Transaction submitted!\n\nPlease check your Klever wallet for confirmation.\n\nYour Numbers:\nMain: ' + selectedMainNumbers.join(', ') + '\nLucky 8Ball: ' + selectedEightball);
              clearSelection();
            }
            
          } catch (buildError) {
            console.error('‚ùå Transaction failed:', buildError);
            console.error('Error details:', {
              message: buildError?.message,
              code: buildError?.code,
              data: buildError?.data
            });
            
            throw buildError; // Re-throw to be caught by outer catch
          }
          
        } catch (err) {
          console.error('‚ùå Ticket purchase failed:', err);
          console.error('Error details:', {
            message: err?.message,
            code: err?.code,
            data: err?.data
          });
          
          alert('‚ùå Transaction failed!\n\nError: ' + (err?.message || err) + '\n\nPlease check:\n1. You have enough KLV (' + TICKET_PRICE + ' + gas)\n2. Your wallet is unlocked\n3. Try again');
        }
      }

      // Prize Claim Function
      async function claimPrize() {
        if (!connectedWallet) {
          alert('‚ùå Please connect your Klever wallet first!');
          return;
        }
        
        const ticketIdInput = document.getElementById('claim-ticket-id');
        const ticketId = ticketIdInput?.value;
        
        if (!ticketId || isNaN(ticketId) || ticketId < 0) {
          alert('‚ùå Please enter a valid ticket ID');
          return;
        }
        
        try {
          if (!window.kleverWeb) {
            alert('‚ùå Klever Wallet not available');
            return;
          }
          
          console.log('üéÅ Claiming prize for ticket:', ticketId);
          
          // Build claim_prize transaction
          const payload = {
            receiver: CONTRACT_ADDRESS,
            amount: 0, // No payment required for claiming
            kda: '',
            data: ['claim_prize', ticketId.toString()]
          };
          
          const txParams = {
            type: 0,
            payload
          };
          
          console.log('üì§ Building claim prize transaction:', txParams);
          
          const builtTx = await window.kleverWeb.buildTransaction([txParams]);
          const signedTx = await window.kleverWeb.signTransaction(builtTx);
          const result = await window.kleverWeb.broadcastTransactions([signedTx]);
          
          if (result && result.data && result.data.txsHashes && result.data.txsHashes.length > 0) {
            const txHash = result.data.txsHashes[0];
            alert('üéÅ Prize claim submitted!\n\nTransaction: ' + txHash + '\n\nCheck KleverScan for confirmation. Your prize will be transferred if you won!');
            ticketIdInput.value = '';
          } else {
            alert('‚úÖ Claim transaction submitted!\n\nCheck your wallet for confirmation.');
            ticketIdInput.value = '';
          }
          
        } catch (err) {
          console.error('‚ùå Claim prize failed:', err);
          alert('‚ùå Error: ' + (err?.message || err));
        }
      }
    </script>
  </body>
</html>
